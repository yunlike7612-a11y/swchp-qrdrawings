<script>
  function textOrDash(v) {
    if (v === null || v === undefined || v === "") return "-";
    return String(v);
  }

  async function main() {
    const params = new URLSearchParams(location.search);
    const id  = params.get("id");   // DrawingNo
    const rev = params.get("rev");  // Rev (없을 수도 있음)

    const status = document.getElementById("statusText");
    const content = document.getElementById("content");

    if (!id) {
      status.textContent = "URL 에 id 파라미터가 없습니다. 예: item_public.html?id=도면번호";
      return;
    }

    status.textContent = "로딩 중... (id = " + id + (rev ? ", rev = " + rev : "") + ")";

    try {
      const res = await fetch("drawings.json");
      if (!res.ok) throw new Error("HTTP " + res.status);
      const list = await res.json();

      let item = null;

      // 1) id + rev 둘 다 넘어온 경우: 정확히 그 개정본 찾기
      if (rev) {
        item = list.find(x =>
          String(x.DrawingNo) === String(id) &&
          String(x.Rev) === String(rev)
        );
      }

      // 2) 못 찾았으면, 같은 도면 중 Current == true 인 최신본
      if (!item) {
        item = list.find(x =>
          String(x.DrawingNo) === String(id) &&
          x.Current === true
        );
      }

      // 3) 그래도 없으면, 같은 도면번호 중 첫 번째
      if (!item) {
        item = list.find(x => String(x.DrawingNo) === String(id));
      }

      // 4) 끝까지 없으면 에러 표시
      if (!item) {
        status.textContent = "";
        content.innerHTML = `
          <div class="box-error">
            <b>해당 ID의 도면을 찾을 수 없습니다.</b><br>
            ID: <code>${id}</code>${rev ? `, Rev: <code>${rev}</code>` : ""}<br><br>
            <div style="font-size:12px;">
              · <code>drawings.json</code> 파일에 이 도면 번호와 개정번호가 있는지 확인해 주세요.<br>
              · JSON 에는 <code>DrawingNo</code>, <code>Rev</code>, <code>Current</code>, <code>Title</code> 필드가 있어야 합니다.
            </div>
          </div>`;
        return;
      }

      // 필드 꺼내기
      const drawingNo = item.DrawingNo;
      const revVal    = item.Rev;
      const title     = item.Title;
      const isLatest  = item.Current === true;

      const badgeClass = isLatest ? "ok" : "warn";
      const badgeText  = isLatest ? "LATEST" : "NOT LATEST";

      document.title = drawingNo + " - Drawing Detail";

      status.textContent = "";

      content.innerHTML = `
        <div class="meta">
          <div>
            <span style="font-weight:700;">${textOrDash(drawingNo)}</span>
            <span class="badge ${badgeClass}">${badgeText}</span>
          </div>
          <dl>
            <dt>Title</dt>
            <dd>${textOrDash(title)}</dd>

            <dt>Revision</dt>
            <dd>${textOrDash(revVal)}</dd>

            <dt>Status (Current)</dt>
            <dd>${isLatest ? "Latest revision" : "Superseded"}</dd>
          </dl>

          <div class="small">
            ※ 이 화면의 데이터는 <code>drawings.json</code> 파일에서 불러온 것입니다.<br>
            파일을 업데이트하면 QR 로 들어오는 정보도 함께 갱신됩니다.
          </div>
        </div>
      `;
    } catch (e) {
      status.textContent = "";
      content.innerHTML = `
        <div class="box-error">
          <b>drawings.json 파일을 불러오는 중 오류가 발생했습니다.</b><br>
          오류 메시지: <code>${e.message}</code>
        </div>`;
    }
  }

  main();
</script>
