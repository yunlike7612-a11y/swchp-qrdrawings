<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Drawing Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
           margin: 20px; color:#222; }
    .wrap { max-width: 720px; margin: 0 auto; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .badge {
      display:inline-block; padding:2px 8px; border-radius:999px;
      font-size:11px; font-weight:600; vertical-align:middle;
    }
    .ok { background:#e6f7e9; color:#0f893a; }
    .warn { background:#fff7e6; color:#a86b00; }
    .err { background:#fde8e8; color:#b10000; }
    .meta { margin-top:12px; border:1px solid #e5e5e5; border-radius:8px; padding:12px; font-size:13px; }
    .meta dt { font-weight:600; margin-top:6px; }
    .meta dd { margin:0; margin-top:2px; color:#444; }
    .small { font-size:12px; color:#777; margin-top:10px; }
    .btn {
      display:inline-block; margin-top:14px; padding:8px 14px;
      border-radius:999px; border:none; text-decoration:none;
      background:#2563eb; color:#fff; font-size:14px;
    }
    .btn:hover { opacity:.9; }
    .box-error {
      border:1px solid #fca5a5; background:#fef2f2;
      border-radius:8px; padding:12px; font-size:13px; color:#b91c1c;
      margin-top:16px;
    }
    code { background:#f3f4f6; padding:2px 4px; border-radius:4px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Drawing Detail</h1>
    <div id="statusText" class="small"></div>
    <div id="content"></div>
  </div>

  <script>
    function textOrDash(v) {
      if (v === null || v === undefined || v === "") return "-";
      return String(v);
    }

    async function main() {
      const status = document.getElementById("statusText");
      const content = document.getElementById("content");

      if (!status || !content) {
        document.body.innerHTML = "<p>구성 오류: statusText / content 영역을 찾을 수 없습니다.</p>";
        return;
      }

      const params = new URLSearchParams(window.location.search);
      const id  = params.get("id");   // DrawingNo
      const rev = params.get("rev");  // Rev (없을 수도 있음)

      if (!id) {
        status.textContent = "URL 에 id 파라미터가 없습니다. 예: item_public.html?id=도면번호";
        return;
      }

      status.textContent = "로딩 중... (id = " + id + (rev ? ", rev = " + rev : "") + ")";

      try {
        const res = await fetch("drawings.json");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const list = await res.json();

        let item = null;

        // 1) id + rev 둘 다 넘어온 경우: 정확히 그 개정본 찾기
        if (rev) {
          item = list.find(x =>
            String(x.DrawingNo) === String(id) &&
            String(x.Rev) === String(rev)
          );
        }

        // 2) 못 찾았으면, 같은 도면 중 Current == true 인 최신본
        if (!item) {
          item = list.find(x =>
            String(x.DrawingNo) === String(id) &&
            x.Current === true
          );
        }

        // 3) 그래도 없으면, 같은 도면번호 중 첫 번째
        if (!item) {
          item = list.find(x => String(x.DrawingNo) === String(id));
        }

        // 4) 끝까지 없으면 에러 표시
        if (!item) {
          status.textContent = "";
          content.innerHTML = `
            <div class="box-error">
              <b>해당 ID의 도면을 찾을 수 없습니다.</b><br>
              ID: <code>${id}</code>${rev ? `, Rev: <code>${rev}</code>` : ""}<br><br>
              <div style="font-size:12px;">
                · <code>drawings.json</code> 파일에 이 도면 번호와 개정번호가 있는지 확인해 주세요.<br>
                · JSON 에는 <code>DrawingNo</code>, <code>Rev</code>, <code>Current</code>, <code>Title</code> 필드가 있어야 합니다.
              </div>
            </div>`;
          return;
        }

        // 필드 꺼내기
        const drawingNo    = item.DrawingNo;
        const revVal       = item.Rev;
        const title        = item.Title;
        const isLatest     = item.Current === true;
        const approvedDate = item.ApprovedDate;   // ✅ 추가

        const badgeClass = isLatest ? "ok" : "warn";
        const badgeText  = isLatest ? "LATEST" : "NOT LATEST";

        document.title = drawingNo + " - Drawing Detail";
        status.textContent = "";

        content.innerHTML = `
          <div class="meta">
            <div>
              <span style="font-weight:700;">${textOrDash(drawingNo)}</span>
              <span class="badge ${badgeClass}">${badgeText}</span>
            </div>
            <dl>
              <dt>Title</dt>
              <dd>${textOrDash(title)}</dd>

              <dt>Revision</dt>
              <dd>${textOrDash(revVal)}</dd>

              <dt>Status (Current)</dt>
              <dd>${isLatest ? "Latest revision" : "Superseded"}</dd>

              <dt>Approved Date</dt>
              <dd>${textOrDash(approvedDate)}</dd>
            </dl>

            <div class="small">
              ※ 이 화면의 데이터는 <code>drawings.json</code> 파일에서 불러온 것입니다.<br>
              파일을 업데이트하면 QR 로 들어오는 정보도 함께 갱신됩니다.
            </div>
          </div>
        `;
      } catch (e) {
        status.textContent = "";
        content.innerHTML = `
          <div class="box-error">
            <b>drawings.json 파일을 불러오는 중 오류가 발생했습니다.</b><br>
            오류 메시지: <code>${e.message}</code>
          </div>`;
      }
    }

    // DOM 로드 후 실행
    window.addEventListener("DOMContentLoaded", main);
  </script>
</body>
</html>


