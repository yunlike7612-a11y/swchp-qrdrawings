<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Drawing Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
           margin: 20px; color:#222; }
    .wrap { max-width: 720px; margin: 0 auto; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .badge {
      display:inline-block; padding:2px 8px; border-radius:999px;
      font-size:11px; font-weight:600; vertical-align:middle;
    }
    .ok { background:#e6f7e9; color:#0f893a; }
    .warn { background:#fff7e6; color:#a86b00; }
    .err { background:#fde8e8; color:#b10000; }
    .meta { margin-top:12px; border:1px solid #e5e5e5; border-radius:8px; padding:12px; font-size:13px; }
    .meta dt { font-weight:600; margin-top:6px; }
    .meta dd { margin:0; margin-top:2px; color:#444; }
    .small { font-size:12px; color:#777; margin-top:10px; }
    .btn {
      display:inline-block; margin-top:14px; padding:8px 14px;
      border-radius:999px; border:none; text-decoration:none;
      background:#2563eb; color:#fff; font-size:14px;
    }
    .btn:hover { opacity:.9; }
    .box-error {
      border:1px solid #fca5a5; background:#fef2f2;
      border-radius:8px; padding:12px; font-size:13px; color:#b91c1c;
      margin-top:16px;
    }
    code { background:#f3f4f6; padding:2px 4px; border-radius:4px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Drawing Detail</h1>
    <div id="statusText" class="small"></div>
    <div id="content"></div>
  </div>

  <script>
    function getIdFromUrl() {
      const params = new URLSearchParams(location.search);
      return params.get("id");
    }

    // drawings.json 에서 어떤 필드를 키로 쓸지 자동으로 추정
    function findById(list, id) {
      if (!Array.isArray(list)) return null;
      const keys = [
        "doc_no","DocNo","DOC_NO",
        "drawing_no","DrawingNo","Drawing_No",
        "id","ID"
      ];
      return list.find(item => {
        return keys.some(k => item[k] && String(item[k]).trim() === id);
      });
    }

    function textOrDash(v) {
      if (v === null || v === undefined || v === "") return "-";
      return String(v);
    }

    async function main() {
      const id = getIdFromUrl();
      const status = document.getElementById("statusText");
      const content = document.getElementById("content");

      if (!id) {
        status.textContent = "URL 에 id 파라미터가 없습니다. 예: item_public.html?id=도면번호";
        return;
      }

      status.textContent = "로딩 중... (id = " + id + ")";

      try {
        const res = await fetch("drawings.json");   // 같은 폴더에 있는 파일
        if (!res.ok) throw new Error("HTTP " + res.status);
        const list = await res.json();

        const item = findById(list, id);
        if (!item) {
          status.textContent = "";
          content.innerHTML = `
            <div class="box-error">
              <b>해당 ID의 도면을 찾을 수 없습니다.</b><br>
              ID: <code>${id}</code><br><br>
              <div style="font-size:12px;">
                · <code>drawings.json</code> 파일에 이 도면 번호가 있는지 확인해 주세요.<br>
                · 키 필드 이름이 <code>doc_no</code>, <code>DocNo</code> 등과 다른 경우 알려주면 수정해 줄게요.
              </div>
            </div>`;
          return;
        }

        // 필드 추출 (없는 건 자동으로 "-")
        const docNo   = item.doc_no || item.DocNo || item.DOC_NO || item.drawing_no || item.DrawingNo || item.id || item.ID;
        const title   = item.title  || item.Title  || item.DWG_TITLE || "";
        const rev     = item.rev    || item.Rev    || item.REV;
        const revDate = item.rev_date || item.RevDate || item.REV_DATE;
        const statusVal = item.status || item.Status || item.DWG_STATUS;
        const isLatest = (item.is_latest !== undefined)
          ? !!item.is_latest
          : (String(statusVal).toUpperCase().includes("LATEST")); // 임시 추정
        const fileUrl = item.file_url || item.FileUrl || item.FILE_URL || item.Url || item.URL;

        const badgeClass = isLatest ? "ok" : "warn";
        const badgeText  = isLatest ? "LATEST" : "NOT LATEST";

        document.title = docNo ? docNo + " - Drawing Detail" : "Drawing Detail";

        content.innerHTML = `
          <div class="meta">
            <div>
              <span style="font-weight:700;">${textOrDash(docNo)}</span>
              <span class="badge ${badgeClass}">${badgeText}</span>
            </div>
            <dl>
              <dt>Title</dt>
              <dd>${textOrDash(title)}</dd>

              <dt>Revision</dt>
              <dd>${textOrDash(rev)}</dd>

              <dt>Revision Date</dt>
              <dd>${textOrDash(revDate)}</dd>

              <dt>Status</dt>
              <dd>${textOrDash(statusVal)}</dd>
            </dl>

            ${fileUrl ? `<a class="btn" href="${fileUrl}" target="_blank" rel="noopener">PDF 열기</a>` : `
              <div class="small">PDF 링크(<code>file_url</code>)가 정의되어 있지 않습니다.</div>
            `}
          </div>

          <div class="small">
            ※ 이 화면의 데이터는 <code>drawings.json</code> 파일에서 불러온 것입니다.<br>
            파일을 업데이트하면 QR로 들어오는 정보도 함께 갱신됩니다.
          </div>
        `;

        status.textContent = "";
      } catch (e) {
        status.textContent = "";
        content.innerHTML = `
          <div class="box-error">
            <b>drawings.json 파일을 불러오는 중 오류가 발생했습니다.</b><br>
            오류 메시지: <code>${e.message}</code><br><br>
            <div style="font-size:12px;">
              · <code>drawings.json</code> 이 레포지토리 루트에 있는지 확인해 주세요.<br>
              · JSON 형식 오류가 있으면 열리지 않습니다. (쉼표, 따옴표 등)
            </div>
          </div>`;
      }
    }

    main();
  </script>
</body>
</html>
